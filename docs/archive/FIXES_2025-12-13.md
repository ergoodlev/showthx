# Critical Bug Fixes - December 13, 2025

## ğŸ¯ Issues Fixed

---

## Issue 1: Frames Not Visible During Recording âœ… FIXED (TWO SQL FILES REQUIRED)

### Problem
- Kids couldn't see frame overlays during video recording
- Logs showed: `ğŸ” Found 0 matching frame assignment(s)` (kid/anon) vs `ğŸ” Found 1 matching frame assignment(s)` (parent/authenticated)

### Root Cause - TWO RLS Policies Needed

The existing policy `"Allow viewing frame assignments for parents and kids"` in [database/fix_frame_rls_for_kids.sql](database/fix_frame_rls_for_kids.sql) checks `WHERE c.id = auth.uid()`, but kids log in **anonymously** using access codes, not Supabase authentication.

**Initial Analysis (Incorrect):**
- Thought only `frame_assignments` table needed RLS policy

**Actual Problem (Discovered from logs):**
The query does:
```javascript
.from('frame_assignments')
.select(`*, frame_templates (*)`)  // â† JOIN to frame_templates
```

Kids need RLS policies for **BOTH tables**:
1. `frame_assignments` - to find which frame is assigned
2. `frame_templates` - to get frame design data (shape, colors, etc.)

**Evidence from logs after first SQL:**
```
ğŸ” Found 1 matching frame assignment(s)  âœ… Can read frame_assignments
âœ… Frame found: {
  "frameId": "b5546461-b4f5-40b4-9b03-257842608162",
  "frameName": undefined,  âŒ JOIN to frame_templates failed
  "frameShape": undefined  âŒ Can't read frame_templates
}
â„¹ï¸  No frame template assigned for this gift
```

### Fix Applied - TWO SQL Files

**File 1:** [database/fix_frame_rls_for_anon_users.sql](database/fix_frame_rls_for_anon_users.sql)

```sql
-- Allow anonymous users (kids) to view frame assignments
CREATE POLICY "Allow anonymous users to view frame assignments"
  ON frame_assignments FOR SELECT
  TO anon
  USING (true);
```

**File 2:** [database/fix_frame_templates_rls_for_anon.sql](database/fix_frame_templates_rls_for_anon.sql)

```sql
-- Allow anonymous users (kids) to view frame templates
CREATE POLICY "Allow anonymous users to view frame templates"
  ON frame_templates FOR SELECT
  TO anon
  USING (true);
```

**Action Required:**
1. Go to **Supabase Dashboard** â†’ **SQL Editor**
2. Run `database/fix_frame_rls_for_anon_users.sql` (if not already run)
3. Run `database/fix_frame_templates_rls_for_anon.sql` âœ… **NEW - MUST RUN THIS**
4. Verify both policies created successfully

**Security Note:**
This is safe because:
- Anonymous users are kids authenticated via access codes
- App logic filters queries by gift/child/event
- Frame templates/assignments contain no sensitive data (just design preferences)
- Kids can only access data for their own session

---

## Issue 2: Placeholder Gifts Visible in Parent Screens âœ… FIXED

### Problem
- Parents saw "tons of people on the gift list" with names like "gift from bob smith from bob smith"
- These are placeholder gifts created during CSV import for guests who didn't bring gifts

### Root Cause
**Placeholder filter only existed in kid screens**

The filter was implemented in [screens/KidPendingGiftsScreen.js](screens/KidPendingGiftsScreen.js#L145-L155) but NOT in parent gift management screens.

Parent screens showed ALL gifts including:
- `name: "Gift from Bob Smith"`
- `giver_name: "Bob Smith"`

### Fix Applied

**Modified:** [screens/GiftManagementScreen.js](screens/GiftManagementScreen.js#L114-L132)

Added placeholder gift filter to `loadGifts()` function:

```javascript
// Filter out placeholder gifts (gifts for guests who didn't bring anything)
// These have the pattern "Gift from {guest name}" or are empty/null
const filteredGifts = (data || []).filter((gift) => {
  const isPlaceholderGift =
    !gift.name ||
    gift.name.trim() === '' ||
    gift.name.toLowerCase().startsWith('gift from') ||
    gift.name.toLowerCase().includes('(no gift)') ||
    gift.name.toLowerCase() === 'no gift';

  if (isPlaceholderGift) {
    console.log('ğŸš« Filtering out placeholder gift:', gift.name, 'from', gift.giver_name);
    return false;
  }
  return true;
});

console.log(`ğŸ“Š Loaded ${data?.length || 0} total gifts, ${filteredGifts.length} after filtering placeholders`);
setGifts(filteredGifts);
```

**Enhanced:** [screens/KidPendingGiftsScreen.js](screens/KidPendingGiftsScreen.js#L153-L169)

Added better logging to show filtering is working:

```javascript
if (isPlaceholderGift) {
  console.log('ğŸš« Filtering out placeholder gift:', gift.name, 'from', gift.giver_name);
  return false;
}

// ... (after filter chain)

const totalBeforeFilter = giftsData?.length || 0;
const totalAfterFilter = transformedGifts?.length || 0;
console.log(`ğŸ“Š Kid gifts: ${totalBeforeFilter} total assignments, ${totalAfterFilter} after filtering`);
```

---

## Issue 3: Video Approval Not Working â³ AWAITING TESTING

### Status
Enhanced error logging already in place ([screens/ParentVideoReviewScreen.js:239-289](screens/ParentVideoReviewScreen.js#L239-L289))

### Next Steps
1. **User must attempt to approve a video**
2. **Check console logs for detailed error:**
   - Error code
   - Error message
   - Error hint
   - Error details
3. **Share error output for diagnosis**

Likely causes:
- RLS policy blocking UPDATE on `videos` table
- RLS policy blocking UPDATE on `gifts` table
- Parent session expired
- Parent ID mismatch

---

## ğŸ“‹ Testing Checklist

### Test 1: Frame Visibility During Recording

**Prerequisites:**
1. Run `database/fix_frame_rls_for_anon_users.sql` in Supabase âœ…
2. Run `database/fix_frame_templates_rls_for_anon.sql` in Supabase âœ… **CRITICAL - NEW**

**Steps:**
1. Login as parent
2. Verify event has a frame assigned (edit event, check frame exists)
3. Logout, login as kid (using access code)
4. Go to pending gifts
5. Click "Record" on any gift
6. **Verify:** Frame overlay appears during recording âœ…
7. **Check logs for:**
   ```
   ğŸ” Found 1 matching frame assignment(s)
   âœ… Frame found: {"frameName": "Test", "frameShape": "scalloped-fancy", ...}
   ğŸ¨ CustomFrameOverlay rendering: {"frame_shape": "scalloped-fancy", ...}
   ```

**Expected Result:**
- Frame IS visible during recording
- Logs show frame assignment found
- Logs show frame template data loaded (frameName and frameShape NOT undefined)
- CustomFrameOverlay renders with actual frame shape

---

### Test 2: Placeholder Gifts Filtered in Parent View

**Steps:**
1. Login as parent
2. Go to Events tab â†’ Select an event â†’ Manage Gifts
3. **Verify:** NO entries with pattern "Gift from [name]" âœ…
4. **Check logs for:**
   ```
   ğŸš« Filtering out placeholder gift: Gift from Bob Smith from Bob Smith
   ğŸ“Š Loaded 43 total gifts, 26 after filtering placeholders
   ```

**Expected Result:**
- Placeholder gifts disappear from parent gift list
- Logs show filtering is working
- Only real gifts with actual names appear

---

### Test 3: Placeholder Gifts Filtered in Kid View

**Steps:**
1. Login as kid (using access code)
2. Go to pending gifts list
3. **Verify:** NO entries with pattern "Gift from [name]" âœ…
4. **Check logs for:**
   ```
   ğŸš« Filtering out placeholder gift: Gift from Beth Kalisch from Beth Kalisch
   ğŸ“Š Kid gifts: 43 total assignments, 26 after filtering
   ```

**Expected Result:**
- Placeholder gifts disappear from kid gift list
- Logs show total before/after counts

---

### Test 4: Video Approval (Diagnostic)

**Steps:**
1. Login as parent
2. Go to Videos tab
3. Click on pending video
4. Click "Approve" button
5. **If it fails:**
   - Check console for detailed error message
   - Share the error code, message, hint, and details

**Expected Result:**
- Either approval succeeds
- OR detailed error message appears in console showing RLS/permission issue

---

## ğŸ“ Files Modified

### New Files
1. **database/fix_frame_rls_for_anon_users.sql** - SQL to fix RLS for `frame_assignments` table
2. **database/fix_frame_templates_rls_for_anon.sql** - SQL to fix RLS for `frame_templates` table âœ… **NEW**

### Modified Files
1. **screens/GiftManagementScreen.js** (lines 114-132)
   - Added placeholder gift filter to parent gift list
   - Added logging for filter results

2. **screens/KidPendingGiftsScreen.js** (lines 153, 166-168)
   - Enhanced placeholder filter logging
   - Added before/after count logging

---

## ğŸ¯ Summary

**3 Critical Issues Addressed:**

1. âœ… **Frame visibility** - Created **TWO** SQL policies:
   - `fix_frame_rls_for_anon_users.sql` - Allow kids to read `frame_assignments`
   - `fix_frame_templates_rls_for_anon.sql` - Allow kids to read `frame_templates` âœ… **MUST RUN BOTH**
2. âœ… **Placeholder gifts** - Added filter to parent gift screens, enhanced logging (CONFIRMED WORKING FROM LOGS)
3. â³ **Video approval** - Enhanced error logging in place, awaiting user test

**Next Step:**
1. **CRITICAL:** Run **BOTH** SQL files in Supabase SQL Editor
2. Test frame visibility during kid video recording
3. Attempt video approval and share error logs if it fails
